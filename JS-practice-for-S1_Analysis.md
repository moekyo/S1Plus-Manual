# S1-JS-Practice 脚本分析记录

## 一、 总体概述

该脚本是一个为 Stage1st 论坛（S1）设计的用户脚本，旨在通过一系列自动化和界面增强功能，优化用户的浏览体验。脚本的核心功能包括链接修正、界面美化、自动操作以及一个复杂的阅读进度跟踪系统。它不依赖 jQuery，而是使用原生 JavaScript、一个外部的本地存储库 `store.js` 以及 Tampermonkey 提供的特定 API 来实现其功能。

## 二、 核心功能模块分析

### 1. 旧链接自动跳转 (Old Link Redirection)
- **功能**: 自动检测并重定向 S1 论坛的旧版帖子链接 (`read-htm-tid-` 格式) 到当前的新版链接格式 (`thread-tid-` 格式)。
- **实现细节**:
    - 使用正则表达式 `oldUrlPattern` 匹配当前页面的 URL。
    - 如果匹配成功，则从 URL 中提取帖子 ID (`tid`)。
    - 通过修改 `location.href` 将用户重定向到新的、标准化的帖子 URL，确保了链接的兼容性。

### 2. 网页标题美化 (Web Page Title Beautification)
- **功能**: 统一并简化浏览器标签页中显示的帖子标题。
- **实现细节**:
    - 通过正则表达式 `titlePattern` 匹配并捕获标题的核心部分。
    - 移除 S1 默认标题中多余的后缀，如 “论坛”、“Stage1st” 等。
    - 为清理后的标题统一添加一个更美观的后缀 ` - STAGE1ₛₜ`。

### 3. 自动签到 (Auto Check-in)
- **功能**: 访问论坛时，自动执行每日签到操作。
- **实现细节**:
    - 通过 `querySelector` 查找包含特定 `href` 的签到链接。
    - 如果找到链接，使用 `setTimeout` 将操作放入宏任务队列，以避免阻塞页面渲染。
    - 调用 S1 论坛页面自身提供的 `ajaxget` 函数来异步访问签到链接，完成签到。
    - 签到完成后，从 DOM 中移除签到链接及其旁边的分隔符，提供操作完成的视觉反馈。

### 4. 漫区随机图更换 (Manga-Zone Random Picture Changer)
- **功能**: 允许用户通过点击更换漫区顶部的随机头图。
- **实现细节**:
    - 通过 `querySelector` 定位到该图片。
    - 为其添加 `click` 事件监听器。
    - 点击时，通过给图片 `src` 链接添加一个当前时间戳作为查询参数，强制浏览器请求一张新的图片。
    - 同时修改鼠标样式为 `pointer` 并添加 `title` 属性，以提升用户交互体验。

### 5. 动态导航栏重构 (Dynamic Navbar Reconstruction)
- **功能**: 废弃论坛默认导航，通过异步请求获取用户收藏的板块列表，并结合预设的快捷入口，动态生成一个新的、个性化的导航栏。
- **实现细节**:
    - 使用 `GM_xmlhttpRequest` API 异步请求论坛的 `forumjump` AJAX 接口，以获取包含收藏板块的 HTML 数据。
    - 使用 `DOMParser` 将返回的 HTML 字符串解析为 DOM 对象，以便于查询。
    - 从解析后的 DOM 中提取出收藏板块的名称和链接。
    - 清空现有导航栏 (`#nv ul`) 的所有内容。
    - 遍历收藏板块列表和预设的快捷入口（如“抹布”、“客户端”），使用 `createLink` 辅助函数创建新的 `<li>` 和 `<a>` 元素，并将其添加到导航栏中。
    - 此功能实现了高度个性化的导航体验。

### 6. 阅读进度跟踪系统 (Reading Progress Tracking System)
- **功能**: 这是脚本最复杂的核心功能。它记录用户在每个帖子中的阅读进度，并在帖子列表页直观地展示出来，包括上次阅读的页码和新增的回复数。
- **实现细节**:
    - **数据存储**: 强依赖 `store.js` 库，在本地存储中维护三个关键对象：
        - `lasttime`: 记录每个帖子的最后访问时间。
        - `lastread`: 记录每个帖子的最后阅读页码。
        - `lastrc`: 记录每个帖子的最后回复数。
    - **帖内操作 (In-Thread Logic)**:
        - 当用户在帖子页面内浏览时，脚本会记录当前的 `tid`。
        - 记录当前的访问时间戳。
        - 通过 `GM_xmlhttpRequest` 异步请求该帖子的移动版 API，以获取并记录最新的总回复数。
        - 记录用户当前所在的页码。
    - **列表页操作 (Thread-List Logic)**:
        - 遍历帖子列表中的每一个帖子。
        - 根据 `tid` 从本地存储中读取该帖子的 `lastread`、`lasttime` 和 `lastrc` 数据。
        - **时间差颜色**: 调用 `getTimeBasedColor` 函数，根据当前时间与上次访问时间的差值，计算出一个从红到灰的渐变颜色，用于高亮显示。时间越近，颜色越红。
        - **“回到第 X 页”链接**: 使用 `createPageLink` 函数生成一个带颜色的、可点击的链接，方便用户直接跳转到上次阅读的页面。
        - **新回复角标**: 对比当前显示的回复数和本地存储的回复数，如果前者更大，则使用 `createReplyBadge` 函数生成一个 `+N` 的角标，提示有新回复。
        - 将生成的链接和角标动态插入到帖子标题的右侧。

## 三、 技术实现分析

- **依赖库**: 核心功能（阅读进度）严重依赖 `store.js` 提供的便捷 LocalStorage API。
- **Greasemonkey API**: 充分利用了 `GM_xmlhttpRequest` 来解决跨域请求问题，这是实现动态导航栏和获取最新回复数的关键。
- **原生 JavaScript**: 整个脚本未使用 jQuery 等框架，完全基于原生 JS API，如 `querySelector`、`createElement`、`addEventListener` 等，脚本轻量且高效。
- **异步编程**: 通过 `setTimeout` 和 `GM_xmlhttpRequest` 的回调函数，实现了非阻塞的异步操作，保证了页面加载和用户体验的流畅性。
- **数据驱动界面**: 阅读进度系统是典型的“数据驱动UI”模式。脚本根据存储的数据动态生成界面元素（链接、角标、颜色），而不是直接操作静态 DOM。
- **代码组织**: 脚本通过函数（如 `createLink`, `getTimeBasedColor` 等）和代码块注释，将不同功能模块化，结构较为清晰。

## 四、 潜在问题与改进点

- **滚动位置记录**: 第 5 点 “滚动位置记录” 功能仅创建了一个节流的空事件监听器，并未实现任何具体逻辑，属于未完成的功能。
- **硬编码**: “自动签到”功能依赖的 `ajaxget` 函数是 S1 页面自带的全局函数，如果论坛前端代码变更，可能导致该功能失效。同样，导航栏中的“默认快捷入口”是硬编码的。
- **错误处理**: 脚本在 `GM_xmlhttpRequest` 中包含了一些基本的 `onerror` 和 `try...catch` 错误处理，但可以进一步增强，以应对更多网络异常或数据格式变更的情况。
