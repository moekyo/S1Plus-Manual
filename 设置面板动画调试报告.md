# S1Plus 设置面板动画机制调试报告

## 调试目标

分析设置面板高度变化时（切换 Tab、展开/收起列表、添加/删除元素等）的动画效果实现逻辑。

---

## 发现的动画机制

S1Plus 设置面板使用了 **三套独立的动画系统**：

### 1. Tab 切换 — ❌ 无动画

| 属性 | 值 |
|------|-----|
| CSS 位置 | 第 1180-1154 行 |
| 实现方式 | `display: none/block` |
| 动画效果 | **无法动画化**（瞬间切换） |

```css
.s1p-tab-content {
  display: none;  /* 隐藏状态 */
}
.s1p-tab-content.active {
  display: block; /* 显示状态 */
}
```

> [!NOTE]
> CSS 的 `display` 属性无法通过 `transition` 实现过渡动画。如需动画效果，需改用 `opacity`、`height` 或 CSS Grid 方案。

---

### 2. 一般可折叠内容（关键字/手动屏蔽列表标题）— ✅ 可动画

| 属性 | 值 |
|------|-----|
| CSS 位置 | 第 1527-1540 行 |
| CSS 类名 | `.s1p-collapsible-content` |
| 实现方式 | `grid-template-rows: 0fr ↔ 1fr` |
| 动画时长 | `0.4s` |

```css
.s1p-collapsible-content {
  display: grid;
  grid-template-rows: 0fr;
  transition: grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1),
              padding-top 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.s1p-collapsible-content.expanded {
  grid-template-rows: 1fr;
  padding-top: 12px;
}
```

---

### 3. 已屏蔽楼层分组列表 — ✅ 可动画

| 属性 | 值 |
|------|-----|
| CSS 位置 | 第 1268-1277 行 |
| CSS 类名 | `.s1p-thread-posts.s1p-collapsible-content` |
| 实现方式 | `max-height: 0 ↔ none` |
| 动画时长 | `0.3s` |

```css
.s1p-thread-posts.s1p-collapsible-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out, padding 0.3s ease-out;
}
.s1p-thread-posts.s1p-collapsible-content.expanded {
  max-height: none;
  padding: 0 12px 12px 12px;
}
```

---

### 4. 功能总开关切换 — ✅ 可动画（JS 控制）

| 属性 | 值 |
|------|-----|
| CSS 位置 | 第 1118-1126 行 |
| JS 位置 | 第 6075-6090 行 |
| CSS 类名 | `.s1p-modal-body` |
| 实现方式 | JavaScript 手动控制 `height` 过渡 |
| 动画时长 | `0.35s` |

#### CSS 定义
```css
.s1p-modal-body {
  transition: height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}
```

#### JavaScript 动画逻辑（FLIP 技术变体）
```javascript
// 第 1 步：锁定旧高度
const oldHeight = modalBody.offsetHeight;
modalBody.style.height = `${oldHeight}px`;

// 第 2 步：触发内容展开/折叠
contentWrapper.classList.toggle("expanded", isChecked);

// 第 3 步：测量新高度
requestAnimationFrame(() => {
  modalBody.style.height = "auto";
  const newHeight = modalBody.offsetHeight;
  modalBody.style.height = `${oldHeight}px`;
  
  // 第 4 步：触发动画
  requestAnimationFrame(() => {
    modalBody.style.height = `${newHeight}px`;
  });
});

// 第 5 步：动画结束后恢复 auto
modalBody.addEventListener("transitionend", function onEnd() {
  modalBody.style.height = "auto";
}, { once: true });
```

---

## 关键发现：S1 NUX 全局覆盖问题

### 问题描述

在启用 S1 NUX 用户样式表的情况下，**所有 S1Plus 的动画设置都会被覆盖**。

### 根本原因

[S1 NUX.css](S1%20NUX.css) 第 **466 行** 定义了一个全局通配符规则：

```css
*:not(.v-binder-follower-content), *::before, *::after {
  transition-timing-function: ease; 
  transition-duration: .15s; 
  transition-property: border, border-color, border-radius, background-color, 
                       color, box-shadow, font-size, font-weight, text-shadow, 
                       opacity, height, line-height, width, max-height, max-width, 
                       transform, padding, margin, text-align, text-decoration;
}
```

### 影响

- 此规则将 **0.15 秒** 的过渡动画应用到页面上几乎所有元素
- 覆盖了 S1Plus 中定义的所有 `transition-duration` 设置
- 导致用户观察到的"短暂动画"实际上是 0.15 秒，而非 S1Plus 设置的时长

### 验证方式

在浏览器控制台执行：
```javascript
const modalBody = document.querySelector('.s1p-modal-body');
console.log('transition:', getComputedStyle(modalBody).transition);
```

启用 S1 NUX 时输出：
```
transition: border 0.15s, border-color 0.15s, ... height 0.15s, ...
```

禁用 S1 NUX 后输出：
```
transition: height 0.35s cubic-bezier(0.4, 0, 0.2, 1)
```

---

### 5. 功能内容展开（总开关下方的子设置）— ⚠️ 动画已禁用

| 属性 | 值 |
|------|-----|
| CSS 位置 | 第 1543-1566 行 |
| CSS 类名 | `.s1p-feature-content` |
| 实现方式 | `grid-template-rows: 0fr ↔ 1fr` |
| 动画时长 | **已禁用**（`transition: none`） |

```css
.s1p-feature-content {
  display: grid;
  grid-template-rows: 0fr;
  /* [调试] 暂时禁用这里的动画，以便测试我们自己的 height 动画 */
  transition: none;
}
```

> [!WARNING]
> 此处动画被显式禁用（`transition: none`），可能是之前调试时遗留的。如需恢复动画，需移除此行或改为具体的 transition 值。

---

### 6. 引用/通知内容展开（帖子内）— ✅ 可动画

| 属性 | 值 |
|------|-----|
| CSS 位置 | 第 1911-1914 行、第 1941-1944 行 |
| CSS 类名 | `.s1p-quote-wrapper`, `.s1p-notification-wrapper` |
| 实现方式 | `max-height` |
| 动画时长 | `0.35s` |

```css
.s1p-quote-wrapper {
  overflow: hidden;
  transition: max-height 0.35s ease-in-out;
}
.s1p-notification-wrapper {
  overflow: hidden;
  transition: max-height 0.35s ease-in-out;
}
```

---

## 动画控制位置汇总

| 组件 | 文件位置 | 动画属性 | 默认时长 | 可动画 |
|------|----------|---------|---------|--------|
| Tab 切换 | L1180-1154 | `display` | N/A | ❌ |
| 一般可折叠内容 | L1527-1540 | `grid-template-rows` | 0.4s | ✅ |
| 已屏蔽楼层分组 | L1268-1277 | `max-height` | 0.3s | ✅ |
| 功能总开关 | L1118-1126, L6075-6090 | `height` (JS) | 0.35s | ✅ |
| 功能内容展开 | L1543-1566 | `grid-template-rows` | **禁用** | ⚠️ |
| 引用展开 | L1911-1914 | `max-height` | 0.35s | ✅ |
| 通知展开 | L1941-1944 | `max-height` | 0.35s | ✅ |
| Tab 滑块 | L4675-4699 | `width`, `transform` (JS) | 0.45s | ✅ |

---

## 调试建议

### 方法 1：临时禁用 S1 NUX

在 Stylus/Stylish 中临时禁用 S1 NUX，然后修改 S1Plus 中的动画时长进行测试。

### 方法 2：使用浏览器开发者工具

1. 打开设置面板
2. 按 F12 打开开发者工具
3. 选择 **Elements（元素）** 面板
4. 选中目标元素（如 `.s1p-collapsible-content`）
5. 在 **Styles（样式）** 面板中直接修改 `transition` 属性
6. 实时观察效果，无需修改代码

### 方法 3：提高 S1Plus 样式优先级

如需在 S1 NUX 启用时仍保持 S1Plus 的动画设置，可考虑：

1. 使用 `!important` 覆盖全局规则
2. 使用更具体的选择器提高优先级
3. 在动画元素上添加 `.v-binder-follower-content` 类（S1 NUX 已排除此类）

---

## 结论

1. **Tab 切换无动画**是预期行为，需重构才能实现动画
2. **列表展开/收起有动画**，时长可在 CSS 中调整
3. **S1 NUX 会覆盖所有动画设置**，调试时需注意
4. 如需自定义动画时长，请参考上表中的文件位置进行修改
